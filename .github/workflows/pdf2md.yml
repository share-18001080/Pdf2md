name: ğŸ“„ PDF to Markdown Converter

on:
  push:
    paths:
      - '**.pdf'           # Chá»‰ cháº¡y khi cÃ³ PDF má»›i/thay Ä‘á»•i
      - 'convert.py'       # Hoáº·c khi script Ä‘Æ°á»£c cáº­p nháº­t
  workflow_dispatch:       # Cho phÃ©p cháº¡y thá»§ cÃ´ng

permissions:
  contents: write

jobs:
  convert-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0     # Láº¥y toÃ n bá»™ lá»‹ch sá»­ Ä‘á»ƒ cÃ³ timestamp chÃ­nh xÃ¡c
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pymupdf4llm
    
    - name: ğŸ”„ Convert PDFs to Markdown (Smart Mode)
      id: convert
      run: |
        python convert.py | tee conversion_log.txt
        echo "log_output<<EOF" >> $GITHUB_OUTPUT
        cat conversion_log.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ“Š Add Job Summary
      if: always()
      run: |
        echo "## ğŸ“„ PDF to Markdown Conversion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```
        cat conversion_log.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ’¾ Commit converted Markdown files
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Chá»‰ add file .md má»›i/thay Ä‘á»•i
        git add **/*.md
        
        if git diff --staged --quiet; then
          echo "âœ… No new Markdown files to commit."
        else
          git commit -m "ğŸ¤– Auto-convert: PDF â†’ Markdown [skip ci]" \
                     -m "Converted by GitHub Actions workflow" \
                     -m "Run #${{ github.run_number }}"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… Committed and pushed converted files."
        fi
    
    - name: ğŸ“¤ Upload Markdown files as artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: markdown-files-${{ github.run_number }}
        path: |
          **/*.md
          !README.md
          !.github/**
        retention-days: 30
        if-no-files-found: warn