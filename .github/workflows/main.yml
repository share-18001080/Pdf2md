name: ğŸ“„ Convert PDF to Markdown

# Trigger khi cÃ³ push hoáº·c cÃ³ thá»ƒ cháº¡y thá»§ cÃ´ng
on:
  push:
    paths:
      - '**.pdf'  # Chá»‰ cháº¡y khi cÃ³ file PDF má»›i Ä‘Æ°á»£c push
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« GitHub UI
  
# Quyá»n cáº§n thiáº¿t Ä‘á»ƒ commit káº¿t quáº£
permissions:
  contents: write

jobs:
  convert-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout repository
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Láº¥y toÃ n bá»™ lá»‹ch sá»­ git
    
    # 2. Setup Python
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache pip dependencies Ä‘á»ƒ tÄƒng tá»‘c
    
    # 3. CÃ i Ä‘áº·t dependencies
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pymupdf4llm
    
    # 4. TÃ¬m vÃ  chuyá»ƒn Ä‘á»•i táº¥t cáº£ file PDF
    - name: ğŸ”„ Convert all PDFs to Markdown
      run: |
        python << 'EOF'
        import pymupdf4llm
        from pathlib import Path
        import sys
        
        def convert_pdf_to_markdown(pdf_path):
            """Chuyá»ƒn Ä‘á»•i má»™t file PDF sang Markdown"""
            try:
                print(f"ğŸ“„ Converting: {pdf_path}")
                
                # Chuyá»ƒn Ä‘á»•i PDF sang Markdown
                md_text = pymupdf4llm.to_markdown(str(pdf_path))
                
                # Táº¡o Ä‘Æ°á»ng dáº«n output (giá»¯ nguyÃªn cáº¥u trÃºc thÆ° má»¥c)
                md_path = pdf_path.with_suffix('.md')
                
                # Ghi file Markdown
                md_path.write_text(md_text, encoding='utf-8')
                
                print(f"âœ… Converted successfully: {md_path}")
                return True
                
            except Exception as e:
                print(f"âŒ Error converting {pdf_path}: {str(e)}")
                return False
        
        # TÃ¬m táº¥t cáº£ file PDF trong thÆ° má»¥c hiá»‡n hÃ nh vÃ  thÆ° má»¥c con
        pdf_files = list(Path('.').rglob('*.pdf'))
        
        if not pdf_files:
            print("âš ï¸  No PDF files found in repository")
            sys.exit(0)
        
        print(f"ğŸ” Found {len(pdf_files)} PDF file(s)")
        print("-" * 60)
        
        # Chuyá»ƒn Ä‘á»•i tá»«ng file
        success_count = 0
        failed_count = 0
        
        for pdf_file in pdf_files:
            # Bá» qua cÃ¡c thÆ° má»¥c áº©n nhÆ° .git
            if any(part.startswith('.') for part in pdf_file.parts):
                continue
                
            if convert_pdf_to_markdown(pdf_file):
                success_count += 1
            else:
                failed_count += 1
        
        print("-" * 60)
        print(f"âœ¨ Conversion complete!")
        print(f"   âœ… Success: {success_count}")
        print(f"   âŒ Failed: {failed_count}")
        
        # Exit vá»›i code 1 náº¿u cÃ³ lá»—i
        if failed_count > 0:
            sys.exit(1)
        
        EOF
    
    # 5. Táº¡o summary report
    - name: ğŸ“Š Generate conversion summary
      if: always()
      run: |
        echo "## ğŸ“„ PDF to Markdown Conversion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** `${{ github.repository }}`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** `${{ github.ref_name }}`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** `${{ github.sha }}`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Äáº¿m sá»‘ file PDF vÃ  MD
        PDF_COUNT=$(find . -name "*.pdf" -not -path "./.git/*" | wc -l)
        MD_COUNT=$(find . -name "*.md" -not -path "./.git/*" -not -name "README.md" | wc -l)
        
        echo "### Conversion Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“„ PDF files found: **${PDF_COUNT}**" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ Markdown files generated: **${MD_COUNT}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List cÃ¡c file Ä‘Ã£ convert
        if [ $MD_COUNT -gt 0 ]; then
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          find . -name "*.md" -not -path "./.git/*" -not -name "README.md" -exec echo {} ; >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        fi
    
    # 6. Upload artifacts (cÃ¡c file Markdown Ä‘Ã£ convert)
    - name: ğŸ“¤ Upload Markdown files as artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: converted-markdown-files
        path: |
          **/*.md
          !README.md
          !.github/**
        retention-days: 30
        if-no-files-found: warn
    
    # 7. Commit vÃ  push káº¿t quáº£ vá» repository (tÃ¹y chá»n)
    - name: ğŸ’¾ Commit converted Markdown files
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add táº¥t cáº£ file .md má»›i
        git add **/*.md
        
        # Chá»‰ commit náº¿u cÃ³ thay Ä‘á»•i
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto-convert: PDF to Markdown [skip ci]
          
          - Converted by GitHub Actions
          - Workflow: ${{ github.workflow }}
          - Run: ${{ github.run_number }}"
          
          git push
        fi
