name: PDF to Markdown (Solution 1 - Bootstrap Phases)

on:
  push:
    paths:
      - "**.pdf"
      - convert_bootstrap.py
  workflow_dispatch:

permissions:
  contents: write

jobs:
  pdf-convert-bootstrap:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Step 1: Install ONLY base requirements (5s)
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      
      - name: Install base requirements (Layer 1+2 support)
        run: |
          pip install --upgrade pip
          pip install -r requirements-bootstrap.txt
        timeout-minutes: 5
      
      # Step 2: Run Bootstrap Phases script (no circular dependency!)
      - name: Convert PDFs (Bootstrap Phases L1→L2→L3→L4→L5)
        run: python convert.py
        timeout-minutes: 180
        continue-on-error: false
      
      # Step 3: Verify LaTeX presence
      - name: Verify LaTeX in outputs
        run: |
          echo "=== LaTeX Verification ==="
          total_md=0
          total_latex=0
          for md in $(find . -name "*.md" -not -path "./.git/*" -not -name "README*"); do
            total_md=$((total_md + 1))
            latex_blocks=$(grep -o '\$\$[^$]*\$\$' "$md" 2>/dev/null | wc -l)
            total_latex=$((total_latex + latex_blocks))
            echo "  ✓ $md: $latex_blocks LaTeX blocks"
          done
          echo "Total: $total_md markdown files, $total_latex LaTeX blocks"
          if [ $total_md -eq 0 ]; then
            echo "❌ FAIL: No markdown files created"
            exit 1
          fi
      
      # Step 4: Commit results
      - name: Git Commit
        if: success()
        run: |
          git config user.email "bot@github.com"
          git config user.name "bot"
          git add -A
          git diff --quiet && exit 0
          git commit -m "Auto-convert: PDF → Markdown (Bootstrap Phases)" \
                     -m "Strategy: Layer 1→L2 probe, L3 decision, L4 install, L5 LaTeX-aware" \
                     -m "Converter: Adaptive (Marker→Nougat→MinerU)"
          git push origin HEAD:${{ github.ref_name }}
      
      # Step 5: GitHub summary
      - name: GitHub Summary
        if: always()
        run: |
          echo "# PDF to Markdown (Bootstrap Phases Solution 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- L1: Bootstrap Core (built-in Python)" >> $GITHUB_STEP_SUMMARY
          echo "- L2: Lightweight Probe (subprocess, no import)" >> $GITHUB_STEP_SUMMARY
          echo "- L3: Decision Engine (rule-based scoring)" >> $GITHUB_STEP_SUMMARY
          echo "- L4: Selective Install (Marker→Nougat→MinerU)" >> $GITHUB_STEP_SUMMARY
          echo "- L5: LaTeX-Aware Conversion + Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Key Benefits" >> $GITHUB_STEP_SUMMARY
          echo "✅ No circular dependency (L1+L2 use built-in only)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Fast bootstrap (5-10s vs 30s probe before)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Graceful fallback (Marker→Nougat→MinerU)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Checkpoint-based resume (avoid re-probing)" >> $GITHUB_STEP_SUMMARY
          echo "✅ LaTeX enforcement (fail if quality gate not met)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Converted Files" >> $GITHUB_STEP_SUMMARY
          find . -name "*.md" -not -path "./.git/*" -not -name "README*" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY || echo "None"
      
      # Step 6: Upload artifacts
      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: bootstrap-markdown-${{ github.run_number }}
          path: "**/*.md"
          retention-days: 60
      
      # Step 7: Upload diagnostic files
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bootstrap-diagnostics-${{ github.run_number }}
          path: "/tmp/bootstrap_*.json"
          retention-days: 30